# GitLab CI equivalent of the GitHub Actions workflow in .github/workflows/ci.yml

workflow:
    rules:
        # Run for merge requests and pushes to main (equivalent to GitHub on: push + pull_request on main)
        -   if: $CI_PIPELINE_SOURCE == "merge_request_event"
        -   if: $CI_COMMIT_BRANCH == "main"

stages:
    - test
    - quality

# Composer cache shared per ref; vendor cached to speed up installs
default:
    cache:
        key: "$CI_COMMIT_REF_SLUG"
        paths:
            - vendor/
            - .composer/cache/

.scripts:
    ssh:
        - eval $(ssh-agent -s)
        - echo "$SSH_PRIVATE_KEY" | base64 -d > /tmp/ssh_key
        - chmod 600 /tmp/ssh_key
        - echo "$SSH_PASSPHRASE" | ssh-add /tmp/ssh_key
        - rm /tmp/ssh_key
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh
        - ssh-keyscan gitlab.algoritma.it >> ~/.ssh/known_hosts
        - chmod 644 ~/.ssh/known_hosts

# Template for tests jobs
# Job using Docker Compose
.tests_template:
    stage: test
    image: docker:20.10.24
    services:
        # We must explicitly disable TLS to fix the "no host" error you saw earlier
        - name: docker:20.10.24-dind
          alias: docker
          command: ["--tls=false"]
    variables:
        # Configure Docker client to talk to the alias "docker" on port 2375
        DOCKER_HOST: tcp://docker:2375
        DOCKER_TLS_CERTDIR: ""
        # Optimize Compose for CI (no interactive, ANSI output)
        COMPOSE_INTERACTIVE_NO_CLI: 1
    before_script:
        # Install docker-compose (the docker image doesn't always have the latest compose plugin)
        - apk add --no-cache docker-compose
    script:
        # 1. Build the stack (uses your docker/php/Dockerfile if defined in compose)
        - docker-compose build

        # 2. Install dependencies
        # We run this inside the 'php' service defined in your docker-compose.yml
        - docker-compose run --rm php composer install --prefer-dist --no-progress

        # 3. Run Tests
        - docker-compose run --rm php vendor/bin/phpunit

        # 4. Cleanup (optional but good practice)
        - docker-compose down

# Matrix of PHP versions for tests
php:tests:
    image: "php:${PHP_VERSION}-cli"
    extends: .tests_template
    parallel:
        matrix:
            -   PHP_VERSION: [ "8.2", "8.3", "8.4" ]

# Static Analysis job with PHP 8.2
quality:
    stage: quality
    image: "jakzal/phpqa:php8.2"
    before_script:
        - !reference [ .scripts, ssh ]
        - composer --version || (curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer)
        - composer config cache-dir .composer/cache
        - composer install --prefer-dist --no-progress
    script:
        - vendor/bin/phpstan analyse
        - vendor/bin/php-cs-fixer fix --dry-run --diff
        - vendor/bin/rector process --dry-run
