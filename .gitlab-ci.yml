# GitLab CI equivalent of the GitHub Actions workflow in .github/workflows/ci.yml

workflow:
    rules:
        # Run for merge requests and pushes to main (equivalent to GitHub on: push + pull_request on main)
        -   if: $CI_PIPELINE_SOURCE == "merge_request_event"
        -   if: $CI_COMMIT_BRANCH == "main"

stages:
    - build
    - test
    - quality

# Composer cache shared per ref; vendor cached to speed up installs
default:
    cache:
        key: "$CI_COMMIT_REF_SLUG"
        paths:
            - vendor/
            - .composer/cache/

.scripts:
    ssh:
        - eval $(ssh-agent -s)
        - echo "$SSH_PRIVATE_KEY" | base64 -d > /tmp/ssh_key
        - chmod 600 /tmp/ssh_key
        - echo "$SSH_PASSPHRASE" | ssh-add /tmp/ssh_key
        - rm /tmp/ssh_key
        - mkdir -p ~/.ssh
        - chmod 700 ~/.ssh
        - ssh-keyscan gitlab.algoritma.it >> ~/.ssh/known_hosts
        - chmod 644 ~/.ssh/known_hosts

build:image:
    stage: build
    image: docker:20.10.24
    services:
        -   name: docker:20.10.24-dind
            alias: docker
            command: [ "--tls=false" ]
    variables:
        DOCKER_HOST: tcp://docker:2375
        DOCKER_TLS_CERTDIR: ""
    before_script:
        - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    script:
        - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -f docker/php/Dockerfile .
        - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

# Template for tests jobs
.tests_template:
    stage: test
    before_script:
        # We assume apt-get dependencies and php extensions are now in the Dockerfile.
        # Ensure Composer is available (if not in Dockerfile, install it here)
        - composer --version || (curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer)
        # Configure Composer cache
        - composer config cache-dir .composer/cache
    script:
        - !reference [ .scripts, ssh ]
        - composer install --prefer-dist --no-progress
        - vendor/bin/phpunit

# Matrix of PHP versions for tests
php:tests:
    image: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
    extends: .tests_template
    parallel:
        matrix:
            -   PHP_VERSION: [ "8.2", "8.3", "8.4" ]

# Static Analysis job with PHP 8.2
quality:
    stage: quality
    image: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
    before_script:
        - !reference [ .scripts, ssh ]
        - composer --version || (curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer)
        - composer config cache-dir .composer/cache
        - composer install --prefer-dist --no-progress
    script:
        - vendor/bin/phpstan analyse
        - vendor/bin/php-cs-fixer fix --dry-run --diff
        - vendor/bin/rector process --dry-run
