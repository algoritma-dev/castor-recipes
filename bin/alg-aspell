#!/usr/bin/env php
<?php

declare(strict_types=1);

if (is_file(__DIR__ . '/../../../../vendor/autoload.php')) {
    require_once __DIR__ . '/../../../../vendor/autoload.php';
} elseif (is_file(__DIR__ . '/../../../vendor/autoload.php')) {
    require_once __DIR__ . '/../../../vendor/autoload.php';
} elseif (is_file(__DIR__ . '/../vendor/autoload.php')) {
    require_once __DIR__ . '/../vendor/autoload.php';
}

use Algoritma\CastorRecipes\Aspell\SpellChecker;
use Symfony\Component\Console\Output\ConsoleOutput;

$output = new ConsoleOutput();
$input = new Symfony\Component\Console\Input\ArgvInput();
$style = new \Symfony\Component\Console\Style\SymfonyStyle($input, $output);

function showHelp(): void
{
    echo <<<'EOD'
        Usage: aspell.php <command> [options]

        Commands:
          check-all [--lang=en] [--files="file1 file2"]  Check all files (text + code)
          check-text [--lang=en]                         Check text files only (md, txt, yaml, json)
          check-code [--lang=en]                         Check PHP code identifiers only
          add-word <word> [--lang=en]                    Add word to personal dictionary
          show-dict [--lang=en]              Show words in personal dictionary
          init [--lang=en]                   Initialize personal dictionary
          help                               Show this help message

        Options:
          --lang=<lang>                      Language code (default: en)
          --ignore-all                       Add all found words to dictionary

        Examples:
          aspell.php check-all
          aspell.php check-text --lang=it
          aspell.php add-word myword
          aspell.php check-all --ignore-all

        EOD;
}

function parseArgs(array $argv): array
{
    $command = $argv[1] ?? 'help';
    $options = [
        'lang' => 'en',
        'ignore_all' => false,
        'word' => null,
        'files' => [],
    ];

    foreach (\array_slice($argv, 2) as $arg) {
        if (str_starts_with((string) $arg, '--lang=')) {
            $options['lang'] = substr((string) $arg, 7);
        } elseif (str_starts_with((string) $arg, '--files=')) {
            $filesStr = substr((string) $arg, 8);
            $options['files'] = array_filter(explode(' ', $filesStr));
        } elseif ($arg === '--ignore-all') {
            $options['ignore_all'] = true;
        } elseif ($command === 'add-word' && $options['word'] === null) {
            $options['word'] = $arg;
        }
    }

    return [$command, $options];
}

function displayResults(array $errors, SpellChecker $checker, bool $ignoreAll): int
{
    global $style;

    if ($errors === []) {
        $style->success("No spelling errors found!");

        return 0;
    }

    if ($ignoreAll) {
        $checker->initPersonalDictionary();
        $addedWords = [];

        foreach ($errors as $errorsList) {
            foreach ($errorsList as $error) {
                $word = $error['word'];
                if ($checker->addToPersonalDictionary($word)) {
                    $addedWords[] = $word;
                }
            }
        }

        if ($addedWords !== []) {
            $style->success(\sprintf("Added %d word(s) to personal dictionary", \count($addedWords)));
            foreach ($addedWords as $word) {
                $style->writeln("  - {$word}");
            }
        } else {
            $style->info("ℹ All words already exist in personal dictionary\n");
        }

        return 0;
    }

    $totalErrors = 0;
    foreach ($errors as $file => $errorsList) {
        $style->section("{$file}");
        foreach ($errorsList as $error) {
            $word = $error['word'];
            $contexts = $error['context'];
            $contextStr = empty($contexts) ? '' : ' (' . implode(', ', $contexts) . ')';
            $style->writeln("  - {$word}{$contextStr}");
        }
        $totalErrors += \count($errorsList);
    }

    $style->error("Found {$totalErrors} potential spelling error(s) in " . \count($errors) . " file(s)");
    $style->info("To add a word to your personal dictionary: aspell.php add-word <word>");
    $style->info("To add all words automatically: add --ignore-all option");

    return 1;
}

// Main
[$command, $options] = parseArgs($argv);
$rootDir = getcwd();
$lang = $options['lang'];

if ($command === 'help') {
    showHelp();
    exit(0);
}

$checker = new SpellChecker($rootDir, $lang);

if (! $checker->isAspellInstalled()) {
    $style->error("aspell is not installed. Please install it first.");
    exit(1);
}

switch ($command) {
    case 'check-all':
        if ($options['files'] !== []) {
            $style->writeln(\sprintf("Checking %d file(s) for spelling errors...", \count($options['files'])));
        } else {
            $style->writeln("Checking all files for spelling errors...");
        }
        $errors = $checker->checkAll($options['files']);
        exit(displayResults($errors, $checker, $options['ignore_all']));

    case 'check-text':
        $style->writeln("Checking text files for spelling errors...");
        $errors = $checker->checkTextFiles();
        exit(displayResults($errors, $checker, $options['ignore_all']));

    case 'check-code':
        $style->writeln("Checking PHP code for spelling errors...");
        $errors = $checker->checkPhpCode();
        exit(displayResults($errors, $checker, $options['ignore_all']));

    case 'add-word':
        if ($options['word'] === null) {
            $style->error("word argument required. Usage: aspell.php add-word <word>");
            exit(1);
        }
        $checker->initPersonalDictionary();
        if ($checker->addToPersonalDictionary($options['word'])) {
            $style->success("✓ Added '{$options['word']}' to personal dictionary (.aspell.{$lang}.pws)");
        } else {
            $style->info("Word '{$options['word']}' already exists in personal dictionary");
        }
        exit(0);

    case 'show-dict':
        $words = $checker->getPersonalDictionaryWords();
        if ($words === []) {
            $style->info("Personal dictionary is empty. Use 'aspell.php add-word <word>' to add words.");
            exit(0);
        }
        $style->writeln(\sprintf("Personal Dictionary (%d words):", \count($words)));
        foreach ($words as $word) {
            $style->writeln("  - {$word}");
        }
        exit(0);

    case 'init':
        $checker->initPersonalDictionary();
        $style->writeln("Personal dictionary initialized at .aspell.{$lang}.pws");
        $style->info("Add project-specific words with: aspell.php add-word <word>");
        exit(0);

    default:
        $style->error("Unknown command '{$command}'");
        showHelp();
        exit(1);
}
